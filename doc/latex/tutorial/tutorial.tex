\documentclass[a4paper,pdftex,12pt]{report}

\usepackage[spanish]{babel}
\usepackage[T1]{fontenc}
\usepackage[latin1]{inputenc}
\usepackage{lmodern,textcomp}
\usepackage[pdftex]{graphicx}
\usepackage[margin=2cm]{geometry}
\usepackage{url}
\usepackage{pdflscape}
\usepackage[pdftex]{hyperref}
\usepackage{listings}
\usepackage{amsfonts}

\lstset{language=Matlab,
  breaklines=true,
  breakatwhitespace=true,
  %numbers=left,
  stepnumber=1,
  numberstyle=\small\color{black},
  tabsize=2,
  basicstyle=\ttfamily,
  numbersep=10pt,
  showspaces=false,
  showstringspaces=false
  %frame=single
}

\hypersetup{
  colorlinks=true,
  bookmarks,
  % citecolor=black,
  % filecolor=black,
  % linkcolor=black,
  % urlcolor=black,
  pdfauthor={Sebastián Múnera Álvarez},
  pdftitle={Tutorial de HORUS},
  pdfkeywords={monitorización costera, HORUS},
  pdfsubject={Tutorial de HORUS}
}

\addto\captionsspanish{%
  \renewcommand{\contentsname}%
    {Contenido}%
  \renewcommand{\listfigurename}%
    {Lista de Figuras}%
  \renewcommand{\listtablename}%
    {Lista de Tablas}%
}



\begin{document}
% \maketitle

\begin{titlepage}
  \large \null\vfill
  
  \begin{center}

    {\huge \textbf{TUTORIAL DE HORUS}}

    \vskip 2cm

    \begin{minipage}[htbp]{1.0\linewidth}
      \begin{center}
        \textbf{Director}:\\
        Andrés Fernando Osorio Arias, Ph.D.\\
        \href{mailto:afosorioar@unal.edu.co}{<\texttt{afosorioar@unal.edu.co}>}\\
      \end{center}
    \end{minipage}
  
    \vskip 2cm

    \begin{minipage}[htbp]{1.0\linewidth}
      \begin{center}
        \textbf{Desarrollo}: \\
        Cristian Andrés Ortiz Alarcón, M.Ing.\\
        \href{mailto:cristian.ortiz.alarcon@gmail.com}{<\texttt{cristian.ortiz.alarcon@gmail.com}>}\\
      \end{center}
    \end{minipage}

    \vskip 1cm

    \begin{minipage}[htbp]{0.5\linewidth}
      \begin{center}
        Juan Camilo Pérez Muñoz, M.Sc.\\
        \href{mailto:jcperezmu@gmail.com
        }{<\texttt{jcperezmu@gmail.com}>}
      \end{center}
    \end{minipage}
    \begin{minipage}[htbp]{0.4\linewidth}
      \begin{center}
        Sebastián Múnera Álvarez, Ing\\
        \href{mailto:sfmunera@unal.edu.co}{<\texttt{sfmunera@unal.edu.co}>}
      \end{center}
    \end{minipage}
  
    \vskip 1cm

    \begin{minipage}[htbp]{1.0\linewidth}
      \begin{center}
        César Augusto Cartagena Ocampo, Ing\\
        \href{mailto:cacartag@unal.edu.co}{<\texttt{cacartag@unal.edu.co}>}\\
      \end{center}
    \end{minipage}

    \vfill
    \begin{minipage}[htbp]{0.4\linewidth}
      \begin{flushleft}
        \includegraphics[height=3cm]{img/horuslogo}
      \end{flushleft}
    \end{minipage}
    \begin{minipage}[htbp]{0.4\linewidth}
      \begin{flushright}
        \includegraphics[height=3cm]{img/unallogo2}
      \end{flushright}
    \end{minipage}

    \begin{minipage}[htbp]{0.4\linewidth}
      \begin{flushleft}
        \includegraphics[height=3cm]{img/aecidlogo}
      \end{flushleft}
    \end{minipage}
    \begin{minipage}[htbp]{0.4\linewidth}
      \begin{flushright}
        \includegraphics[height=2.5cm]{img/ihlogo}
      \end{flushright}
    \end{minipage}
  \end{center}


  
\end{titlepage}

\tableofcontents
\listoffigures
% \listoftables

\chapter{Instalar HORUS}
El sistema HORUS fue diseñado para trabajar con la versión de
MATLAB\textregistered\ R2011b o superior y requiere el Toolbox de
Procesamiento de Imágenes, el de Bases de datos y el de Adquisición de
Imágenes. Si su instalación de MATLAB\textregistered\ cumple los
requisitos básicos puede poner los archivos del sistema HORUS en
cualquier directorio, para el ejemplo se ubicará en el directorio
\verb$C:\horus$. El computador donde se ejecute el sistema HORUS debe
contar mínimo con 2GB de memoria RAM.

Para visualizar todas las interfaces gráficas apropiadamente, se
recomienda una resolución de pantalla mínima de $1200 \times 800$.

Para instalar HORUS, basta con descomprimir el paquete
\texttt{horus.zip}, que contiene los códigos en MATLAB, y los scripts
para configurar el sistema. La estructura de directorios del paquete
consta de las siguientes partes:

\begin{itemize}
\item \emph{data}: Contiene los archivos de configuración necesarios
  para ejecutar diferentes tareas, datos de usuario que es necesario
  mantener almacenados, como las rutas de las imágenes, entre otros.
\item \emph{doc}: La documentación del sistema HORUS que incluye el
  manual de referencia donde se describen todos los procesos, todas
  las interfaces gráficas, y este tutorial.
\item \emph{examples}: Ejemplos de imágenes y scripts de SQL para
  configurar la base de datos, y hacer pruebas con las interfaces
  gráficas.
\item \emph{gui}: Todas las interfaces gráficas del sistema que
  utilizan las funciones en MATLAB para llevar a cabo los distintos
  procesos, así como para la configuración de la base de datos,
  captura y automáticos. Cada interfaz es independiente de las demás,
  en el sentido de que no requieren como entrada las salidas de otras
  interfaces.
\item \emph{io}: Todas las rutinas para la comunicación con la base de
  datos. Es necesario haber configurado una base de datos como se
  explica en la sección \ref{chap:bd}.
\item \emph{src}: Las funciones en MATLAB que conforman el corazón del
  sistema. Cada función realiza una tarea específica dentro de los
  procesos de HORUS, entre ellas se encuentran las que permiten
  rectificar y fusionar imágenes, calcular los parámetros de los
  modelos de optimización, entre otros.
\item \emph{tmp}: Contiene la información temporal generada durante
  una sesión, como datos cuya vida útil es mientras se ejecuta un
  algoritmo o información de la sesión del usuario.
\end{itemize}

El primer paso para este tutorial es ejecutar la interfaz principal de
HORUS (ver figura~\ref{fig:guimain}).

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_guimain}
  \caption{Interfaz principal de HORUS}
  \label{fig:guimain}
\end{figure}

Para ejecutar la interfaz principal, en la línea de comandos de
Matlab, es necesario ubicarse en el directorio de \verb!horus!, y
escribir el siguiente comando:

\begin{verbatim}
> gui_main
\end{verbatim}

Cuando se ejecuta por primera vez alguna de las interfaces que se
usará en este tutorial, se despliega una interfaz para hacer el
\textit{login} en la base de datos, con el usuario creado previamente
en la instalación. En la figura~\ref{fig:login} se muestra la interfaz
de \textit{login} diligenciada. Esta información sólo se ingresa una
vez y permanece mientras dure la sesión. Cuando se cierra una
interfaz, se le pregunta al usuario si desea cerrar la sesión o no.
Si se está trabajando con una base de datos remota y se presentan
fallos en la red o Internet, es decir, se pierde la conexión con la
base de datos se mostrará de nuevo la interfaz de \textit{login}.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.2\textwidth]{img/tutorial_login}
  \caption{Interfaz de login diligenciada}
  \label{fig:login}
\end{figure}

El manejo de sesiones en HORUS no tiene que ver con la conexión a la
base de datos y la vigencia de ésta, sino con la información del
archivo \texttt{userinfo.dat} del directorio \texttt{tmp}. Este
archivo de texto plano contiene el nombre de usuario de la base de
datos (\textit{user}), la contraseña encriptada (\textit{password}),
la dirección del servidor de la base de datos (\textit{host}), el
puerto (\textit{port}) y el nombre de la base de datos
(\textit{dbname}). Cuando un usuario se loguea, debe ingresar toda la
información mencionada para la conexión a la base de datos, y se crea
el archivo \texttt{userinfo.dat}. Cuando, por ejemplo, el usuario
cierra una interfaz gráfica, el sistema le pregunta al usuario si
desea cerrar la sesión, en caso afirmativo, el archivo
\texttt{userinfo.dat} es borrado, y en caso negativo no se hace nada.
En conclusión, mientras el archivo \texttt{userinfo.dat} exista, hay
una sesión de HORUS abierta, y se cierra cuando el archivo es borrado.

\chapter{Instalar y configurar la base de datos}
\label{chap:bd}

El sistema HORUS fue diseñado para trabajar con una base de datos
relacional en MySQL. Antes de trabajar con HORUS es necesario
configurar la base de datos ya que en ésta va a estar almacenada toda
la información necesaria para el funcionamiento de HORUS. Es posible
trabajar con el sistema HORUS a partir de una base de datos existente
a la que se pueda acceder, bien sea mediante una red local o por
Internet. Si no hay una base de datos, es necesario configurar una
nueva desde cero.

Para crear una nueva base de datos con la estructura de HORUS se debe
disponer del servidor de bases de datos MySQL.

Para la instalación y configuración básica del servidor MySQL se deben
seguir los siguientes pasos:

\begin{enumerate}
\item Instalar el servidor de MySQL siguiendo los pasos del instalador
  (si ya existe una instalación anterior de MySQL, no es necesario
  volver a instalarlo ya que puede generar problemas debido a cuentas
  de usuario anteriores). Se puede descargar desde
  \texttt{\url{http://dev.mysql.com/downloads/mysql/}}. En los pasos
  de la instalación se deben tener en cuenta los siguientes aspectos:
  \begin{itemize}
  \item Seleccionar instalación \emph{Típica}.
  \item Seleccionar la opción ``Instalar como \emph{Servicio del
      sistema}''.
  \item Seleccionar la opción ``Incluir la ruta de la instalación en
    el \verb!PATH! del sistema''.
  \item Reiniciar PC.
  \item Por defecto, existe un usuario administrador del servidor (\verb!root!). Se
    debe especificar la contraseña de este usuario. Esta
    contraseña se necesitará más adelante para crear la base de datos
    de HORUS.
  \end{itemize}

  Si se quiere instalar el servidor de MySQL en Linux, es suficiente
  con instalarlo desde el repositorio de paquetes de la distribución
  específica.
\end{enumerate}

Para configurar la base de datos de HORUS se debe presionar el botón
\textbf{Setup database} de la interfaz principal, el cual despliega la
interfaz de configuración de la base de datos de HORUS. Para este
tutorial, la información diligenciada en los campos de la interfaz
son:

\begin{itemize}
\item \emph{Database host}: \texttt{localhost}
\item \emph{Database name}: \texttt{horusdb}
\item \emph{Database port}: \texttt{3306}
\item \emph{Admin username}: \texttt{horususer}
\item \emph{Admin password}: \texttt{abc123}
\item \emph{Database SQL file}: \verb!C:\horus\examples\horus.sql!
\end{itemize}

La información diligenciada se muestra en la
figura~\ref{fig:tutorial_setupdb}.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.4\textwidth]{img/tutorial_setupdb}
  \caption{Datos diligenciados en la interfaz de configuración de la
    base de datos}
  \label{fig:tutorial_setupdb}
\end{figure}

Por último, presionar el botón \textit{Apply configuration} para
generar la nueva base de datos. Para generar la nueva base de datos se
debe ingresar la contraseña del usuario \verb!root! previamente
configurada.

Después de realizar la operación, el sistema responde con un mensaje
de confirmación.


\chapter{Creación de una estación, cámaras, GCPs y rutas de imágenes}

A medida que se desarrolla el tutorial pueden aparecer diferentes avisos
emergentes que indican que la interfaz está haciendo algún
procesamiento, estos avisos no deben ser cerrados ya que puede
interferir en el desarrollo del tutorial.
\\

En esta interfaz no se habilitan los botones hasta que no se hayan
diligenciado correctamente los campos solicitados, por esta razón es
necesario que al diligenciar el último campo, si no se han habilitado
estos botones, presione \textit{Enter} o haga clic fuera del campo
para que se activen.

\section{Estación}

Después de haber configurado la base de datos e instalado HORUS se
realizan las primeras inserciones en la base de datos. Para el
desarrollo de este tutorial se asume que la base de datos está vacía,
sin ningún tipo de información. Lo primero que se insertará será la
estación, para ello se presiona el botón \textbf{Edit database} en la
interfaz principal. Se mostrará una ventana donde se puede ingresar la
información de la estación haciendo clic en el menú superior
\emph{Edit Station}, luego seleccionando de la lista desplegable
\emph{New station}. Se ingresa la información solicitada con los
datos de la estación como se muestra en el ejemplo:

\begin{enumerate}
\item \emph{Name}: CARTAGENA
\item \emph{Alias}: CRTG
\item \emph{Elevation}: 85
\item \emph{Latitude}: 10.397283333
\item \emph{Longitude}: -75.5619194444
\item \emph{Country}: Colombia
\item \emph{State}: Bolivar
\item \emph{City}: Cartagena
\item \emph{Manager}: HORUS
\item \emph{Description}: Esta estación está ubicada en el edificio
  Bavaria en Bocagrande.
\end{enumerate}

En la figura~\ref{fig:tutorial_station} se muestra la interfaz después
de diligenciar la información.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_station}
  \caption{Interfaz diligenciada con la estación}
  \label{fig:tutorial_station}
\end{figure}

\begin{itemize}
\item Por último se presiona en el botón \emph{Insert}.
\item Se abrirá una ventana para confirmar la acción a la cual se le
  debe responder con \emph{Yes}.
\item Al finalizar el proceso, saldrá una ventana indicando el éxito o
  el fracaso de la operación.
\end{itemize}

Si en el proceso anterior se presionó el botón \emph{Insert} y se
requiere cambiar la información insertada, se puede actualizar yendo
de nuevo al menú superior \emph{Edit Station}, seleccionando la
estación a cambiar, seleccionando la estación a cambiar, renovando la
información necesaria y presionando el botón \emph{Update}.

Si tiene alguna duda sobre el tipo de dato o cuál es el significado de
alguna opción de esta interfaz diríjase al manual de HORUS en la
sección GUI en el apartado de \emph{Edit database} - Estación.

\section{Cámara}

Luego de haber insertado una estación, se procede a insertar las
cámaras, para esto se hace lo siguiente:

\begin{itemize}
\item Ir al menú superior \emph{Edit Camera} de la interfaz.
\item En la lista desplegable \emph{Station} seleccionar la estación a
  la que se le asociarán las cámaras, en este caso será CARTAGENA.
\item En la lista desplegable \emph{Camera}, seleccionar \emph{New
    camera}.
\item Ingresar la información solicitada con los datos de la cámara,
  como en el siguiente ejemplo:
\end{itemize}

\begin{enumerate}
\item \emph{Id Camera}: C1
\item \emph{Reference}: Stingray
\item \emph{Size X}: 1024
\item \emph{Size Y}: 768
\end{enumerate}

En la figura~\ref{fig:tutorial_camera} se muestra la interfaz después
de diligenciada.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_camera}
  \caption{Interfaz diligenciada con la información de la cámara}
  \label{fig:tutorial_camera}
\end{figure}

\begin{itemize}
\item Por último, presionar el botón \emph{Insert}.
\item Se mostrará una ventana de confirmación a la cual se le debe
  responder con \emph{Yes}.
\item Al finalizar la inserción, se mostrará una ventana indicando el
  éxito o el fracaso de la operación.
\end{itemize}

Al igual que en el anterior apartado, se puede actualizar la
información ingresada seleccionando de la lista desplegable
\emph{Camera} la cámara que se desea actualizar, cambiando la
información necesaria y presionando el botón \emph{Update}.

Este proceso de inserción debe repetirse para las cámaras \textit{C2}
y \textit{C3}, cambiando en la información sólo el \emph{Id Camera}
por C2 y C3, esto con el fin de que los demás ejemplos puedan
realizarse.

Si tiene alguna duda sobre el tipo de dato o cuál es el significado de
alguna opción de esta interfaz diríjase al manual de HORUS en la
sección GUI en el apartado de \emph{Edit database} - Cámara.

\section{GCP}
\label{subsetion:gcp}
Ahora se insertarán los GCPs. Para esto se hace lo siguiente:

\begin{itemize}
\item Ir al menú superior \emph{Edit GCP}.
\item Seleccionar de la lista desplegable \emph{Station} la estación a
  la cual se asociarán los GCPs, para el ejemplo se escogerá
  CARTAGENA.
\item En la lista desplegable \emph{GCP} se selecciona \emph{Import
    GCPs}.
\item Se abrirá una nueva ventana en la cual se debe seleccionar el
  archivo a importar, que en este caso es \emph{GCPs.xls} ubicado en
  el directorio \emph{examples} de HORUS. Éste debe ser un archivo de
  Excel y debe tener cinco columnas: Id del GCP, el cual es un número
  entero; el nombre del GCP, por lo general es GCPXXX donde XXX es un
  numero asociado a éste; la coordenada \textit{X}, la coordenada
  \textit{Y} y la coordenada \textit{Z}. Este archivo tendrá tantas
  filas como GCPs se deseen insertar. Este archivo no debe contar con
  ningún tipo de encabezado y debe tener sólo una hoja de cálculo. En
  la figura~\ref{fig:tutorial_gcp2} se muestra la estructura del
  archivo de Excel.
\end{itemize}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_gcp_excel}
  \caption{Estructura de excel para importar GCPs}
  \label{fig:tutorial_gcp2}
\end{figure}

En la figura~\ref{fig:tutorial_gcp} se muestra la interfaz después de
diligenciada.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_gcp}
  \caption{Interfaz diligenciada con la información de los GCPs}
  \label{fig:tutorial_gcp}
\end{figure}

\begin{itemize}
\item Por último, presionar el botón \emph{Insert}.
\item Se mostrará una ventana de confirmación en la cual se responde
  \emph{Yes}.
\item Este proceso puede tardar unos segundos dependiendo de la
  cantidad de GCPs a insertar.
\item Al finalizar, se mostrará una ventana indicando la cantidad de
  GCPs insertados exitosamente.
\end{itemize}

Dada la cantidad de GCPs a insertar y para agilizar el proceso, se usó
la opción de importar los GCPs por archivo externo, pero se pueden
insertar los GCPs uno a uno seleccionando en la lista desplegable
\emph{GCP} la opción de \emph{New GCP}, ingresando la información
solicitada de cada uno y presionando el botón \emph{Insert}. Esta
interfaz también cuenta con la opción de actualizar un GCP
seleccionándolo de la lista desplegable \emph{GCP}, cambiando la
información necesaria y presionando el botón \emph{Update}.

Si tiene alguna duda sobre el tipo de dato o cuál es el significado de
alguna opción de esta interfaz diríjase al manual de HORUS en la
sección GUI en el apartado de \emph{Edit database} - GCP.



\section{Generar las rutas de las imágenes}

Finalmente, se crearán los directorios en el disco duro local donde
las imágenes generadas por HORUS serán almacenadas. Para esto se
siguen los siguientes pasos:

\begin{itemize}
\item Ir al menú superior \emph{Generate Image Paths}.
\item Seleccionar de la lista desplegable \emph{Station} la estación,
  para el ejemplo se escogerá CARTAGENA.
\item En el campo \emph{Captured images} seleccionar la ruta de las
  imágenes oblicuas, para el ejemplo será:
  \verb$C:\horus\examples\dbimage$.
\item En el campo \emph{Result images} seleccionar la ruta raíz a
  partir de la cual se generarán los subdirectorios para el resto de
  las imágenes, para el ejemplo será: \verb$C:\horus\examples$.
\item Presionar el botón \emph{Save} que crea el archivo
  \verb!path_info.xml! en el directorio \texttt{data} de HORUS.
\end{itemize}

Los subdirectorios generados para cada tipo de imagen tienen la
siguiente estructura:

\begin{itemize}
\item \verb$rectified$
\item \verb$merged\oblique$
\item \verb$merged\rectified$
\item \verb$thumbnail\oblique$
\item \verb$thumbnail\rectified$
\item \verb$thumbnail\merged\oblique$
\item \verb$thumbnail\merged\rectified$
\end{itemize}


Para el ejemplo, se supone que el sistema HORUS está en el disco
\texttt{C:}, en caso contrario se deben utilizar las rutas
correctas. En la figura~\ref{fig:tutorial_pathdb} se muestra la
interfaz con esta información diligenciada.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.6\textwidth]{img/tutorial_pathdb}
  \caption{Interfaz diligenciada con las rutas de las imágenes}
  \label{fig:tutorial_pathdb}
\end{figure}

Si tiene alguna duda al respecto diríjase al manual de HORUS en la
sección GUI, en el apartado de \emph{Edit database} - Generar rutas de
imágenes.

\chapter{Create new user}

Si se quiere crear un nuevo usuario con permisos limitados (e.g. un
usuario de sólo lectura), se ejecuta la interfaz gráfica
\textbf{Create new user} desde la interfaz principal (ver
figura~\ref{fig:guiuser}), donde se especifica el nombre de usuario, la
contraseña, la base de datos a la que tiene permiso de conectarse y si
tiene permiso de consultar (\textit{query}), insertar
(\textit{insert}), borrar (\textit{delete}) o actualizar
(\textit{update}) la información en la base de datos.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.4\textwidth]{img/tutorial_guiuser}
  \caption{Interfaz para crear un nuevo usuario con permisos
    limitados}
  \label{fig:guiuser}
\end{figure}


\chapter{Configurar Cámaras}

HORUS es un sistema de captura y procesamiento de imágenes
ambientales. El componente de captura es el más importante pues es el
que provee la información necesaria para ser posteriormente
procesada. El primer paso para configurar la captura es configurar las
cámaras que actúan como dispositivos de captura.

En este paso es indispensable contar con el toolbox de Adquisición de
Imágenes de MATLAB. Se configurará una cámara web conectada al
computador de captura con el sistema operativo Windows 7, con el
adaptador por defecto en MATLAB \texttt{winvideo}, teniendo en cuenta
que éste no es un ejemplo real de configuración de las cámaras en una
estación ya que se requieren mejores equipos, sólo es un ejemplo de
cómo se configuraría una cámara. Se supone que ya la base de datos de
HORUS está configurada con la información de la estación y las cámaras
conectadas al computador de captura.

Si se ha conectado la cámara web luego de haber iniciado MATLAB, es
necesario ejecutar el comando \verb!imaqreset! con el fin de que
MATLAB reconozca que la cámara está conectada.

Para comenzar, se presiona el botón \textbf{Configure cameras} en la
interfaz principal.

En la figura~\ref{fig:tutorial_camconf} se muestra la interfaz de
configuración de las cámaras. Los pasos para la configuración son los
siguientes:

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.8\textwidth]{img/tutorial_camconf}
  \caption{Ejemplo de configuración de las cámaras}
  \label{fig:tutorial_camconf}
\end{figure}

\begin{itemize}
\item Seleccionar un adaptador de vídeo, en este caso, se trabajará
  con el adaptador \texttt{winvideo}, el cual es el adaptador por
  defecto en Windows.
\item Para cada adaptador hay un conjunto de cámaras asociadas a
  él. Para el ejemplo, solamente hay una cámara conectada con ID 1.
\item Luego de seleccionar el dispositivo, se selecciona un formato,
  para el ejemplo es \texttt{YUY2\_1280x720} compuesto por el formato
  de píxeles, e.g.\@ YUV, y la resolución de la captura, e.g.\@
  1280x720.
\item Es posible tener distintas estaciones en la base de datos, así
  que hay que seleccionar una de ellas en la cual se haría la captura,
  e.g.\@ \texttt{CARTAGENA}.
\item El dispositivo que se seleccionó se debe asociar con una de las
  cámaras de la base de datos para la estación escogida, en este caso
  el dispositivo con ID 1, corresponde a la cámara \texttt{C1}.
\item La velocidad de captura o \textit{framerate} es el número de
  \textit{frames} que va a capturar la cámara en un segundo. Se debe
  seleccionar un \textit{framerate} entre las opciones que el
  dispositivo provee. Para el ejemplo, se escogió un
  \textit{framerate} de 10.
\item Se debe seleccionar el modo de ganancia, el modo de disparo y el
  modo de balance de blancos.
\item Por último, si la cámara es AVT \textit{Firewire}, se puede
  seleccionar un área de interés (AOI) la cual es la región de la
  imagen que será utilizada para calcular los valores de la Ganancia,
  Disparo y Balance de blancos en caso de ser escogidos en la
  configuración de la cámara.
\end{itemize}

Toda la configuración es almacenada en el archivo
\texttt{capture\_info.xml} el cual se encuentra en el directorio
\texttt{data}. Para la configuración del ejemplo, el archivo contiene
lo siguiente:

\begin{verbatim}
<?xml version="1.0" encoding="iso-8859-1"?>
<Configuration station="CARTAGENA">
    <CameraConfig>
        <Camera id="C1">
            <FrameRate>10</FrameRate>
            <GainMode>none</GainMode>
            <ShutterMode>none</ShutterMode>
            <WhiteBalanceMode>auto</WhiteBalanceMode>
            <AdaptorName>winvideo</AdaptorName>
            <DeviceID>1</DeviceID>
            <DeviceFormat>YUY2_1280x720</DeviceFormat>
            <AOI>
                <mode>none</mode>
                <Height>none</Height>
                <Width>none</Width>
                <Left>none</Left>
                <Top>none</Top>
            </AOI>
        </Camera>
    </CameraConfig>
</Configuration>
\end{verbatim}

Esta configuración es utilizada por el automático de captura como se
explicará más adelante.

\chapter{Insertar Imágenes Oblicuas de ejemplo}

Es posible que antes de instalar o configurar una estación se disponga
de un grupo de imágenes oblicuas, rectificadas o fusionadas que deben
estar presentes en la base de datos. Esta sección indica cómo insertar
la información de estas imágenes en la base de datos. Este proceso se
realiza de forma manual utilizando la línea de comandos de Matlab.

En este paso se procederá a insertar las imágenes existentes en el
disco. Esto sólo se debe hacer si se tienen de antemano imágenes de la
estación, y la base de datos no contiene imágenes en la estación
CARTAGENA. Si es la primera vez que instala HORUS y no existe ninguna
imagen, este paso no es necesario ya que las imágenes se insertarán en
la base de datos al momento de la captura y la transmisión. Sin
embargo, para efectos del tutorial, se requiere realizar este paso.

Como ejemplo, se insertarán las imágenes de prueba de la estación
CARTAGENA ubicadas en el directorio \emph{examples} del paquete HORUS
(disponible también en
\url{http://www.horusvideo.com/dbimage.zip}). Sabiendo esto, desde la
línea de comandos se llamará a la función
\texttt{insert\_images\_recursively} del directorio \emph{io}, que tiene
como datos de entrada la ruta donde se encuentran las imágenes y la
estación asociada a ellas.

Para usar esta función se debe tener la estructura de directorios para
almacenar las imágenes oblicuas y la estructura de nombres de las
imágenes de HORUS. La estructura de directorios se muestra en la
figura~\ref{fig:tutorial_insert_obli} y debe contener lo siguiente, en
forma anidada:

\begin{itemize}
\item Directorio con el nombre de la estación en mayúsculas.
\item Directorio con el año, en formato \texttt{aaaa}.
\item Directorio con el mes, en formato \texttt{mm}.
\item Directorio con el día, en formato \texttt{dd}.
\item Directorio con el nombre de la cámara con el formato
  \texttt{C<numero de cámara>} (si las imágenes son oblicuas).
\end{itemize}

El directorio que contendrá las imágenes de las estaciones, en este
caso tiene el nombre \texttt{dbimage}, no tiene restricciones con el
nombre.

\begin{figure}[htbp!]
  \centering
  \includegraphics[scale=0.5]{img/tutorial_insert_obli}
  \caption{Estructura de las carpetas de almacenamiento de las
    imágenes}
  \label{fig:tutorial_insert_obli}
\end{figure}

La estructura del nombre de la imagen se muestra en la
figura~\ref{fig:tutorial_insert_obli2},
y debe ser de la forma:

\begin{verbatim}
<año(aa)>.<mes(mm)>.<dia(dd)>.<hora(HH)>.<minutos(MM)>.<segundos(SS)>.
<zonahoraria>.<estación>.C<número de cámara>.<tipo de fotografía>.
<ancho>X<largo>.<sistema>.jpg
\end{verbatim}


La hora debe estar en formato 24 horas.

\begin{figure}[htbp!]
  \centering
  \includegraphics[scale=0.5]{img/tutorial_insert_obli2}
  \caption{Estructura del nombre de las imágenes}
  \label{fig:tutorial_insert_obli2}
\end{figure}

En la línea de comandos de MATLAB se debe copiar la siguiente
instrucción\footnote{Es posible que al copiar y pegar este comando,
  las \texttt{'} no sean las mismas que MATLAB utiliza}:

\begin{verbatim}
> insert_images_recursively('C:\horus\examples\dbimage','CARTAGENA','oblique')
\end{verbatim}

Esta función insertará todas las imágenes que están en la ruta
\verb$C:\horus\examples\dbimage$ dentro de la estación,
\texttt{CARTAGENA}. Cada vez que se inserte una imagen se mostrará un
mensaje en la línea de comandos de MATLAB, indicando
el éxito o el fracaso de la operación. Así:

\begin{verbatim}
Image 10.05.01.16.00.00.GMT.CARTAGENA.C3.Timex.1024X768.HORUS.jpg successfully 
inserted!.
\end{verbatim}


Se repite el proceso para cada estación en la que se desee hacer la inserción.

Para comprobar que las imágenes hayan sido insertadas exitosamente, se
puede usar la función \texttt{load\_allimage} del directorio \emph{io}
que tiene como datos de entrada la conexión a la base de datos (la
cual se crea escribiendo en la línea de comandos:
\verb!conn = connection_db();!), los tipos de imágenes, la cámara, la
estación y las fechas de inicio y fin de la búsqueda (en el formato de
\texttt{datenum}). Esta función retornará la información de las
imágenes de la base de datos que cumplan con la información
ingresada. Ahora, en línea de comandos de MATLAB se
ingresa\footnote{Es posible que al copiar y pegar este comando, las
  \texttt{'} no sean las mismas que MATLAB utiliza}:

\begin{verbatim}
> imagenesC1=load_allimage(conn, {'snap','timex'},'C1','CARTAGENA',734259,734262);
\end{verbatim}

La función retorna todas las imágenes tipo \textit{snap} y
\textit{timex} de la cámara \texttt{C1}, en la estación
\texttt{CARTAGENA} entre el 01/05/2010 00:00 ($734259$) y el
04/05/2010 00:00 ($734262$).

Ya que esta función sólo permite una cámara a la vez, se debe repetir
el proceso para las demás cámaras, así:

\begin{verbatim}
> imagenesC2=load_allimage(conn, {'snap','timex'},'C2','CARTAGENA',734259,734262);
> imagenesC3=load_allimage(conn, {'snap','timex'},'C3','CARTAGENA',734259,734262);
\end{verbatim}

El número de imágenes para cada cámara debe ser $193$ y se puede
comprobar con los siguientes comandos:

\begin{verbatim}
> size(imagenesC1, 1)
> size(imagenesC2, 1)
> size(imagenesC3, 1)
\end{verbatim}

\chapter{Configurar rectificación}
\label{seccion:calibration}
Ahora se crearán las calibraciones para la rectificación de imágenes,
para luego ser insertadas en la base de datos.

Para ejecutar la interfaz, presionar el botón \textbf{Configure
  rectification} de la interfaz principal.

En el cuadro \emph{Select station, camera and image}:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Camera}: C1
\item \emph{Image time}: 1-mayo del 2010 a las 10:45:00 (01/05/2010
  10:45:00)
\end{enumerate}

Luego se procede a presionar el botón \emph{Load image} para cargar la
imagen. Al cargar la imagen se mostrarán los mensajes de advertencia
\emph{No ROI was found in the database!}  y \emph{No picked GCPs were
  found in the database!}, sin embargo, esto es normal ya que no se
han insertado aún los ROIs y los GCPs escogidos, y es lo que se hará
en este proceso. En cada ventana de error es suficiente con presionar
el botón \emph{OK} para continuar.\\

En el cuadro \emph{Choose ROI \& GCPs for calibration}:

\begin{itemize}
\item En la lista desplegable de GCPs se escogerán los
  correspondientes a la cámara C1 que se usarán para la calibración.
\item Es posible marcar manualmente los GCPs escogiendo uno por uno de
  la lista de GCPs y presionando el botón \emph{Mark} para marcar las
  coordenadas $(u, v)$ sobre la imagen. Sin embargo, para este
  tutorial se tiene un archivo de EXCEL o MAT con la información de
  los GCPs escogidos (nombre del GCP, e.g.\@ GCP001, coordenada en U y
  coordenada en V), que se puede cargar presionando el botón
  \emph{Import picked GCPs}. Se dispone de los archivos
  \texttt{picked\_GCPs\_C1.xls}, \texttt{picked\_GCPs\_C2.xls} y
  \texttt{picked\_GCPs\_C3.xls} que contienen la información de los
  GCPs escogidos.
\item Al marcar un GCP aparecerá un (*) al lado derecho del nombre que
  indica que está marcado en la imagen.
\item Al hacer las marcaciones se pueden usar las opciones de
  \textit{zoom} y desplazamiento, los cuales se encuentran en la parte
  superior izquierda de la interfaz.
\item Si se desea remover una marcación, se selecciona el GCP y se
  deselecciona \emph{Pick GCP}.
\item Si se desea eliminar la coordenada $(u, v)$, se presiona el
  botón \emph{Clear}.
\item Por último, se escribe la resolución de las imágenes en
  \emph{Resolution (m/pix)}, para este ejemplo será de 0.5 para todas
  las cámaras.
\end{itemize}

En este punto, se supone que ya se han ingresado los GCPs del archivo
\emph{GCPs.xls} como se explica en la
subsección~\ref{subsetion:gcp}. En la
figura~\ref{fig:tutorial_calibration2} se muestra cómo debe quedar
este cuadro diligenciado. Los GCPs en el archivo utilizado para el
ejemplo se muestran gráficamente en las
figuras~\ref{fig:tutorial_gcpC1},~\ref{fig:tutorial_gcpC2},
y~\ref{fig:tutorial_gcpC3}.

\begin{figure}[htbp!]  \centering
  \includegraphics[scale=0.5]{img/tutorial_calibration2}
  \caption{Cuadro \emph{Choose ROI \& GCPs for calibration}}
  \label{fig:tutorial_calibration2}
\end{figure}

\begin{figure}[htbp!]  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_gcpC1}
  \caption{GCPs para la cámara C1}
  \label{fig:tutorial_gcpC1}
\end{figure}

\begin{figure}[htbp!]  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_gcpC2}
  \caption{GCPs para la cámara C2}
  \label{fig:tutorial_gcpC2}
\end{figure}

\begin{figure}[htbp!]  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_gcpC3}
  \caption{GCPs para la cámara C3}
  \label{fig:tutorial_gcpC3}
\end{figure}


Después de marcar los puntos en la imagen, es posible exportarlos a un
archivo de EXCEL o MAT, con el botón \textit{Export picked GCPs...},
para ser utilizados posteriormente.

Ahora, se selecciona el ROI de interés, para esto se presiona el botón
\emph{Select ROI...} que despliega la interfaz para definir un ROI
asociado a una calibración. Esta interfaz puede ser usada de dos
formas. La primera es como se hará a continuación, llamándola desde
otra interfaz y parte de la información es transferida en el
llamado. La segunda forma es presionando el botón \textbf{Create new
  ROI} en la interfaz principal donde se debe diligenciar toda la
información manualmente, como se describe en el
apéndice~\ref{app:roi}.

En la interfaz de creación de ROI, parte de la información está
completa, por lo tanto se procede a presionar el botón \emph{Mark
  Points} para marcar la región de interés en la imagen, haciendo clic
sobre la imagen en los puntos correspondientes a los vértices del
polígono del ROI. Se debe tener en cuenta que el último punto a marcar
se marca con clic derecho para cerrar el polígono del ROI. En la parte
superior izquierda de la interfaz se cuenta con las opciones de
\textit{zoom}, desplazamiento sobre la imagen y borrado de los puntos
marcados si es necesario.  Por último, para agregar el ROI a la
interfaz de calibración, se debe cerrar esta interfaz haciendo clic en
la \textbf{X} en la parte superior derecha. En la
figura~\ref{fig:tutorial_roi} se muestra la interfaz diligenciada para
la cámara C1.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_roi}
  \caption{Interfaz de ROI diligenciada llamada desde otra interfaz}
  \label{fig:tutorial_roi}
\end{figure}

Las coordenadas $u$ y $v$ del ROI para la cámara C1 son:

\begin{verbatim}
U Points: 60.17 457.98 979.56 1020.82 1020.82 391.68
V Points: 293.89 762.42 765.37 727.06 248.21 74.35
\end{verbatim}


Para la cámara C2 son:

\begin{verbatim}
U Points: 4.18 231.08 986.93 1022.29 1023.76 521.34 309.17 4.18
V Points: 690.23 766.84 766.84 625.40 149.50 2.16 2.16 180.44
\end{verbatim}


Para la cámara C3 son:

\begin{verbatim}
U Points: 2.71 4.18 236.98 1022.29 534.60 69.01
V Points: 453.01 766.84 766.84 626.87 273.26 279.15
\end{verbatim}


Estas coordenadas pueden ser escritas directamente en la interfaz de
ROI en el área de texto \emph{U Points} y \emph{V Points}, y al
presionar \textit{Enter}, después de haber escrito todas las
coordenadas, éstas se graficarán sobre la imagen. Se sugiere que a la
hora de realizar la calibración de cada cámara, se ingrese esta
información de coordenadas para obtener resultados similares a los
presentados en este tutorial.

En el cuadro \emph{Select calibration method}, en la lista desplegable
\emph{Calibration method} se debe escoger el método con el que se hará
la calibración, es recomendable escoger el método \emph{Pinhole} y es
el que se usará para el ejemplo. Después de seleccionarlo y si se
tienen estimados iniciales de una calibración anterior se mostrarán
sus valores, de los cuales se seleccionarán cuáles se tendrán en
cuenta para calcular los nuevos parámetros. Dado que para el ejemplo
es la primera vez que se realiza una calibración, no se contará con
los estimados iniciales, lo cual hará que se muestre una ventana
indicando esto en la cual se debe presionar el botón \emph{OK} para
continuar. Si ya se ha calculado una calibración anteriormente,
automáticamente sus parámetros se convierten en los estimados
iniciales para la siguiente calibración. Si se desean borrar los
estimados iniciales se puede usar el botón \emph{Clear}.

Por defecto, se muestran seleccionados todos los parámetros aunque
estén vacíos. Para el ejemplo, sólo se deseleccionarán los parámetros
\emph{k1} y \emph{k2}. En la figura~\ref{fig:tutorial_calibration} se
muestra cómo debe quedar diligenciada la interfaz.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_calibration}
  \caption{Interfaz de calibración diligenciada}
  \label{fig:tutorial_calibration}
\end{figure}

Los parámetros \emph{k1} y \emph{k2} son los parámetros de distorsión
y se deseleccionan con el fin de que el método dé una mejor solución,
ya que las cámaras de CARTAGENA tienen poca distorsión. Después de
esto se presiona el botón \emph{Calculate parameters} para resolver el
modelo. Al resolver el modelo, sobre la imagen se mostrarán los GCPs
calibrados, como se muestra en la
figura~\ref{fig:tutorial_calibration3} y se mostrará una imagen
rectificada de ejemplo para validar la calidad de la calibración.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.8\textwidth]{img/tutorial_calibration3}
  \caption{Solución del método Phinole}
  \label{fig:tutorial_calibration3}
\end{figure}

Después de resolver el modelo, en la línea de comandos de MATLAB se
mostrará un mensaje en el cual se indican los errores de la
calibración. Si se considera que es apropiado, se puede guardar esta
calibración o se pueden cambiar los estimados iniciales y los GCPs
seleccionados para obtener mejores resultados.

Para la cámara C1, después de haber ingresado la información antes
mencionada aparecen los siguientes errores de calibración:

\begin{verbatim}
The camera transformation matrix is:
  1.0e+005 *
  0.0011    0.0044   -0.0061   -2.2626
  0.0002   -0.0011   -0.0059    0.8416
  -0.0000    0.0000   -0.0000    0.0011

  The distortion parameters are: k1 = 0.000000e+000, k2 = 0.000000e+000
  The image projection error is 1.132297e+000 pixels
  The space back projection error is 3.223257e-001 meters
  The normalized calibration error is 6.538403e-004
\end{verbatim}


Para la cámara C2, se debe mostrar:

\begin{verbatim}
The camera transformation matrix is:
  1.0e+005 *
  0.0054    0.0051    0.0035   -4.4830
  0.0007   -0.0012    0.0032    0.8345
  -0.0000    0.0000    0.0000   -0.0014

  The distortion parameters are: k1 = 0.000000e+00, k2 = 0.000000e+00
  The image projection error is 2.929746e+00 pixels
  The space back projection error is 6.374538e-01 meters
  The normalized calibration error is 1.835119e-03
\end{verbatim}



y para la cámara C3, se debe mostrar:

\begin{verbatim}
The camera transformation matrix is:
  1.0e+05 *
  -0.0024   -0.0000   -0.0027    1.0283
  -0.0004    0.0003   -0.0049   -0.2108
  -0.0000   -0.0000   -0.0000    0.0009

  The distortion parameters are: k1 = 0.000000e+00, k2 = 0.000000e+00
  The image projection error is 1.236531e+00 pixels
  The space back projection error is 3.082079e-01 meters
  The normalized calibration error is 3.158604e-03
\end{verbatim}



Si se considera que la calibración es adecuada, se procede a guardarla
(los valores de error obtenidos deben ser muy parecidos a los
mostrados), para esto se va al menú superior \emph{Options} y se
escoge la opción \emph{Save calibration}. Al presionar este botón,
saldrá una ventana confirmando la acción, en la cual indicaremos
\emph{Yes}. También, en este menú se tiene la opción \emph{Show
  calibration} la cual, después de haber generado una calibración se
puede volver a visualizar. Si se quiere ver la imagen rectificada de
nuevo se puede hacer clic en este mismo menú en \textit{Show rectified
  image}.  Para el ejemplo, se deben guardar las calibraciones de las
cámaras C1, C2, C3 con los errores antes mencionados. En las
figuras~\ref{fig:tutorial_rectgoodC1},~\ref{fig:tutorial_rectgoodC2}
y~\ref{fig:tutorial_rectgoodC3} se muestran imágenes rectificadas para
las cámaras C1, C2 y C3 con calibraciones adecuadas; y en las
figuras~\ref{fig:tutorial_rectbadC1},~\ref{fig:tutorial_rectbadC2}
y~\ref{fig:tutorial_rectbadC3} se muestran imágenes rectificadas de
las cámaras C1, C2 y C3 con calibraciones no adecuadas.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_rectgoodC1}
  \caption{Imagen rectificada, calibración adecuada C1}
  \label{fig:tutorial_rectgoodC1}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_rectbadC1}
  \caption{Imagen rectificada, calibración no adecuada C1}
  \label{fig:tutorial_rectbadC1}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_rectgoodC2}
  \caption{Imagen rectificada, calibración adecuada C2}
  \label{fig:tutorial_rectgoodC2}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.3\textwidth]{img/tutorial_rectbadC2}
  \caption{Imagen rectificada, calibración no adecuada C2}
  \label{fig:tutorial_rectbadC2}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.3\textwidth]{img/tutorial_rectgoodC3}
  \caption{Imagen rectificada, calibración adecuada C3}
  \label{fig:tutorial_rectgoodC3}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.3\textwidth]{img/tutorial_rectbadC3}
  \caption{Imagen rectificada, calibración no adecuada C3}
  \label{fig:tutorial_rectbadC3}
\end{figure}

Se debe hacer lo indicado anteriormente para las cámaras C1, C2 y C3
con los datos importados de los archivos XLS y los otros pasos
indicados para que los ejemplos siguientes puedan funcionar
correctamente, cambiando en el cuadro \emph{Select station, camera and
  image} la cámara en \emph{Camera} por cada una de las cámaras antes
mencionadas.

Si tiene alguna duda sobre cuál es el significado de alguna opción de
esta interfaz diríjase al manual de HORUS en la sección GUI en el
apartado de \emph{Configure rectification}.


\chapter{Rectificar imágenes en lote}

Luego de configurar las calibraciones, es posible rectificar imágenes
en lote. Para rectificar un grupo de imágenes, se presiona el botón
\textbf{Manually rectify images} en la interfaz principal.

En la figura \ref{fig:tutorial_rectify} se muestra un ejemplo de
configuración. Para el ejemplo, se ingresa la siguiente información:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Image type}: snap
\item \emph{Camera}: C1
\item \emph{Select a calibration}: Default
\item \emph{Initial time}: 01/05/2010 10:45:00
\item \emph{Final time}: 01/05/2010 22:45:00
\item \emph{Time error}: 3
\item \emph{Time step}: 30
\end{enumerate}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_rectify}
  \caption{Ejemplo de interfaz de rectificación}
  \label{fig:tutorial_rectify}
\end{figure}

Es posible escoger una calibración anterior desde el menú
\textit{Select a calibration}, pero para este ejemplo, se dejará la
opción por defecto, en la que cada imagen es rectificada con la
calibración más cercana (en tiempo) al tiempo de la imagen, almacenada
en la base de datos.

La región de interés será la misma que está almacenada junto con la
calibración más cercana antes de la fecha inicial.

Para este tutorial, las imágenes serán guardadas solamente en el
disco. Se debe escoger la opción \textit{Save images in disk only} y
se debe seleccionar la ruta de destino haciendo clic en el botón
``$\ldots$''.

Para iniciar el proceso de rectificación se debe hacer clic en el
botón \textit{``Start rectification''}, y luego aparecerá una ventana
de progreso donde es posible cancelar la ejecución (ver
figura~\ref{fig:tutorial_rectprogress}).
\\

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_rectprogress}
  \caption{Ventana de progreso del proceso de rectificación}
  \label{fig:tutorial_rectprogress}
\end{figure}

Si tiene alguna duda sobre cuál es el significado de alguna opción de
esta interfaz diríjase al manual de HORUS en la sección GUI en el
apartado de \emph{Manually rectify images}.

\chapter{Configurar Fusiones}

En esta parte del tutorial se explicará cómo generar los parámetros
para la fusión ya sea de imágenes oblicuas o rectificadas. Para
ejecutar la interfaz se debe presionar el botón \textbf{Configure
  fusion} en la interfaz principal.

A continuación, se describe cómo configurar los parámetros para la
fusión para imágenes oblicuas y rectificadas.

\section{Imágenes Oblicuas}

En el cuadro \emph{Select station and time}, se ingresa la siguiente
información:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Time}: 01/05/2010 10:45:00
\item \emph{Rectified, Oblique}: En éste seleccionaremos
  \textit{Oblique}.
\item \emph{Time error (sec)}: 30
\end{enumerate}

En el cuadro \emph{Select camera order} se selecciona el orden en que
se fusionarán las imágenes. Para el ejemplo se hará en el orden
C1--C2--C3, para ello se selecciona de la lista desplegable la cámara C1
y se presiona el botón $\gg$ para agregarlo a la lista del cuadro del
lado derecho.  Luego, se repite el proceso para C2 y por último para
C3. 

Se escoge el tipo de imágenes usadas para la configurar la fusión, en
este caso \textit{snap}.

Luego de esto, se presiona el botón \emph{Load images}, el cual
cargará las imágenes en pares con el orden que se indicó, primero
C1--C2 y luego
C2--C3.\\

En el cuadro \emph{Select affine points}:

\begin{itemize}
\item Se seleccionan los puntos en común entre las imágenes. Por
  defecto, si existen fusiones anteriores en la base de datos, se
  cargan los puntos comunes asociados a esta fusión, si no existen
  fusiones anteriores se cargan los GCPs que sean comunes en ambas
  cámaras, en este caso en C1--C2 se cargan los GCPs con nombre GCP007,
  GCP008 y GCP009 si se siguieron las indicaciones de la
  sección~\ref{seccion:calibration} de calibración.
\item Para que la fusión de las imágenes sea mejor se agregará otro
  punto en común, para esto se presiona el botón \emph{New common
    point}.
\item Se marca el punto, primero sobre la imagen izquierda (C1) y
  luego sobre la imagen derecha (C2).
\item Si es necesario, en la parte superior izquierda se cuenta con
  las opciones de \textit{zoom} y desplazamiento sobre la imagen para
  facilitar la marcación.
\item La marcación en la cámara C1 tiene las coordenadas $u: 807$ y
  $v: 642$. La marcación en la cámara C2 tiene las coordenadas $u:
  196$ y $v: 604$.
\item Las cifras decimales en los puntos marcados pueden ser
  diferentes a los mostrados en el ejemplo, pero la parte entera debe
  coincidir.
\item Si se desean cambiar las coordenadas de un punto, se selecciona
  éste en la lista desplegable \emph{Common GCPs}. Luego se presiona
  el botón \emph{Mark} y se marca el punto, primero sobre la imagen de
  la izquierda y luego sobre la imagen de la derecha.
\item Todos los puntos seleccionados para tener en cuenta se mostrarán
  con un (*) al lado derecho del nombre.
\item Estos cuatro puntos son suficientes para continuar, pero si es
  el caso, se pueden quitar puntos seleccionando el nombre del punto
  en \emph{Common GCPs} y luego deseleccionando la opción \emph{Pick}.
\item Para el ejemplo, se selecciona el método \textit{Affine}. Se
  pueden escoger los otros métodos \textit{Projective},
  \textit{Optimized Affine} y \textit{Optimized Projective}, teniendo
  en cuenta que para utilizar el método de transformación proyectiva
  se debe contar mínimo con cuatro puntos comunes. Para ver el
  resultado de la fusión entre las dos imágenes con el método
  escogido, se puede presionar el botón \emph{Preview}.
\end{itemize}

En la figura~\ref{fig:tutorial_genfusion} se muestra la interfaz
después de diligenciada.  Habiendo seleccionado los puntos comunes, se
presiona el botón \emph{Continue} el cual mostrará el otro par de
cámaras, en este caso C2--C3.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_genfusion}
  \caption{Interfaz diligenciada para generar los parámetros de fusión
    de imágenes oblicuas}
  \label{fig:tutorial_genfusion}
\end{figure}

Al cargar las imágenes de las cámaras C2--C3 se muestran los GCPs con
nombre GCP014, GCP015 y GCP016 estos puntos son suficientes para hacer
la fusión, pero igual que el ejemplo anterior, se pueden agregar o
quitar puntos como se desee.  Habiendo seleccionado los puntos en
común se presiona el botón \emph{Calculate}.  Después de esto se
calcularán los parámetros de la fusión y se mostrará una imagen
fusionada, como la de la figura~\ref{fig:tutorial_genfusion3}, si es
correcta se puede proceder a guardar los parámetros de la fusión, en
caso contrario se pueden cambiar y/o agregar puntos en común para
mejorar la fusión.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.8\textwidth]{img/tutorial_genfusion3}
  \caption{Imagen fusionada a partir de imágenes oblicuas}
  \label{fig:tutorial_genfusion3}
\end{figure}

Si se desea usar el método \textit{Projective} para las cámaras C2--C3
se debe tener cuidado al seleccionar los puntos comunes entre las
cámaras ya que este método es muy sensible y puede arrojar fusiones
erróneas, en la figura~\ref{fig:tutorial_genfusion_projective} se
muestra la fusión seleccionando puntos aleatorios, mostrando un
resultado no deseado y en la
figura~\ref{fig:tutorial_genfusion_projective2} se muestra la fusión
seleccionando puntos más adecuados lo que arroja un mejor resultado.
Este proceso se lleva a cabo por ensayo y error.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.8\textwidth]{img/tutorial_genfusion_projective}
  \caption{Imagen fusionada erróneamente con el método \emph{projective}}
  \label{fig:tutorial_genfusion_projective}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.8\textwidth]{img/tutorial_genfusion_projective2}
  \caption{Imagen fusionada exitosamente con el método \emph{projective}}
  \label{fig:tutorial_genfusion_projective2}
\end{figure}

Es posible importar los puntos comunes, presionando el botón
\textit{Import common points...}, si se dispone de un archivo con
formato EXCEL o MAT que tenga las siguientes columnas: ID de la
cámara, nombre del punto, coordenada en U y coordenada en V. Asimismo,
es posible que después de marcar todos los puntos comunes para todas
las cámaras y de haber calculado los parámetros, exportar los puntos
marcados a un archivo con el mismo formato, presionando el botón
\textit{Export common points...}.

Para guardar los parámetros de la fusión se debe ir al menú superior
\emph{Options} y hacer clic en \emph{Save fusion calibration}. Esto
abrirá una ventana de confirmación en la cual se indica \emph{Yes}.
Si se quiere ver la imagen fusionada de nuevo se puede hacer clic en
este mismo menú en \emph{Show merged image}.

Si tiene alguna duda sobre cuál es el significado de alguna opción de
esta interfaz diríjase al manual de HORUS en la sección GUI en el
apartado de \emph{Configure fusion}.

\section{Imágenes Rectificadas}

Después de hacer el paso anterior se puede proceder a configurar los
parámetros de fusión para las imágenes rectificadas.

En el cuadro \emph{Select station and time}, se ingresan los
siguientes datos de ejemplo:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Time}: 01/05/2010 10:45:00
\item \emph{Rectified, Oblique}: En éste seleccionaremos
  \textit{Rectified}.
\item \emph{Time error (sec)}: 30
\end{enumerate}

En el cuadro \emph{Select camera order} se selecciona el orden en que
se fusionarán las imágenes. Las cámaras para el ejemplo son
C1--C2--C3. Para ello se selecciona de la lista desplegable la
cámara C1 y se presiona el botón $\gg$ para agregarlo a la lista del
cuadro del lado derecho. Luego, se repite el proceso para C2 y por
último para C3. 

Se escoge el tipo de imágenes usadas para la configurar la fusión, en
este caso \textit{snap}.

Luego de esto, se presiona el botón \emph{Load images}, el cual
cargará las imágenes en pares con el orden que se indicó, en este caso
primero C1--C2 y luego C2--C3.  Esto puede tardar unos segundos ya que
se deben rectificar las
imágenes antes de mostrarlas.\\

En el cuadro \emph{Select affine points}:

\begin{itemize}
\item Se seleccionan los puntos en común de las imágenes. Por defecto,
  si existen fusiones anteriores en la base de datos, se cargan los
  puntos comunes asociados a esta fusión, si no existen fusiones
  anteriores se cargan los GCPs que sean comunes en ambas cámaras, en
  este caso en C1--C2 carga los GCPs con nombre GCP007, GCP008 y GCP009
  si se siguieron las indicaciones de la
  sección~\ref{seccion:calibration} de calibración.
\item Se agregará un nuevo punto como se indicó anteriormente. En la
  figura~\ref{fig:tutorial_genfusion5} se muestra este punto marcado,
  que corresponde a la esquina superior derecha de la caseta azul.
\item Estos cuatro puntos son suficientes para continuar, pero si es
  el caso, se pueden quitar puntos seleccionándolos en \emph{Common
    GCPs} y luego deseleccionando la opción \emph{Pick}.
\item Si se desea cambiar las coordenadas de un punto, se selecciona
  en la lista desplegable \emph{Common GCPs}, se presiona el botón
  \emph{Mark}, y se marca el punto como el caso anterior, primero
  sobre la imagen de la izquierda y luego en la imagen de la derecha.
\item Todos los puntos seleccionados para tener en cuenta se mostrarán
  con un (*) al lado derecho del nombre.
\item Para el caso de la fusión de imágenes rectificadas, se debe
  utilizar el método \textit{Affine}. Habiendo seleccionado los puntos
  comunes se presiona el botón \emph{Continue} el cual mostrará el
  otro par de cámaras, en este caso C2--C3.
\end{itemize}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_genfusion5}
  \caption{Marcación del nuevo punto común en generar fusión}
  \label{fig:tutorial_genfusion5}
\end{figure}

Al cargar las imágenes de las cámaras C2--C3 se muestran los GCPs con
nombres GCP014, GCP015 y GCP016, los cuales son suficientes para hacer
la fusión, pero al igual que el caso anterior, se pueden agregar o
quitar puntos como se desee.  En la
figura~\ref{fig:tutorial_genfusion2} se muestra la interfaz
diligenciada con la información.  Habiendo seleccionado los puntos en
común, se presiona el botón \emph{Calculate}.  Después
de esto, se hace la rectificación y la fusión de las imágenes y se
mostrará una imagen fusionada como la de la
figura~\ref{fig:tutorial_genfusion4}. Si es adecuada, se puede
proceder a guardar los parámetros de la fusión, en caso contrario, se
pueden cambiar y/o agregar puntos en común para mejorar la fusión.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_genfusion2}
  \caption{Interfaz diligenciada para generar los parámetros de fusión
    de imágenes rectificadas}
  \label{fig:tutorial_genfusion2}
\end{figure}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.5\textwidth]{img/tutorial_genfusion4}
  \caption{Imagen fusionada a partir de imágenes rectificadas}
  \label{fig:tutorial_genfusion4}
\end{figure}

Es posible importar los puntos comunes, presionando el botón
\textit{Import common points...}, si se dispone de un archivo con
formato EXCEL o MAT que tenga las siguientes columnas: ID de la
cámara, nombre del punto, coordenada en U y coordenada en V. Asimismo,
es posible que después de marcar todos los puntos comunes para todas
las cámaras y de haber calculado los parámetros, exportar los puntos
marcados a un archivo con el mismo formato, presionando el botón
\textit{Export common points...}.

Para guardar los parámetros de la fusión se debe ir al menú superior
\emph{Options} y hacer clic en \emph{Save fusion calibration} esto
abrirá una ventana de confirmación en la cual se indica \emph{Yes}.
Si se quiere ver la imagen fusionada de nuevo se puede hacer clic en
este mismo menú en \emph{Show merged image}.

Si tiene alguna duda sobre cuál es el significado de alguna opción de
esta interfaz diríjase al manual de HORUS en la sección GUI en el
apartado de \emph{Configure fusion}.

\chapter{Fusionar imágenes en lote}

Luego de configurar las fusiones, es posible fusionar imágenes en
lote. El proceso de fusión de imágenes en lote es muy similar al de
rectificación de imágenes en lote. Para ejecutar la interfaz se debe
presionar el botón \textbf{Manually merge images} en la interfaz
principal.

En la figura \ref{fig:tutorial_fusion} se muestra un ejemplo de
configuración para la fusión de un grupo de imágenes oblicuas.  Para
el ejemplo, se ingresa la siguiente información:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Image type}: snap
\item \emph{Select a fusion}: Default
\item \emph{Initial time}: 01/05/2010 10:45:00
\item \emph{Final time}: 01/05/2010 22:45:00
\item \emph{Time error}: 3
\item \emph{Time step}: 30
\end{enumerate}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_fusion}
  \caption{Ejemplo de interfaz de fusión, imágenes oblicuas}
  \label{fig:tutorial_fusion}
\end{figure}

En el ejemplo, se fusionan las imágenes oblicuas en el intervalo de
tiempo seleccionado. Al iniciar el proceso de fusión, aparece una
ventana de progreso donde es posible cancelar la ejecución (ver figura
\ref{fig:tutorial_fusionprogress}).

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_fusionprogress}
  \caption{Ventana de progreso del proceso de fusión}
  \label{fig:tutorial_fusionprogress}
\end{figure}

Para este tutorial, las imágenes serán guardadas solamente en el
disco. Se debe escoger la opción \textit{Save images in disk only} y
se debe seleccionar la ruta de destino haciendo clic en el botón
``$\ldots$''. Las imágenes quedan almacenadas como se muestra en la
figura~\ref{fig:tutorial_mergedfolder}.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_mergedfolder}
  \caption{Imágenes fusionadas almacenadas en disco}
  \label{fig:tutorial_mergedfolder}
\end{figure}

Para iniciar el proceso de fusión se debe presionar el botón
\textit{``Start fusion''}, y luego aparecerá una ventana de progreso
donde es posible cancelar la ejecución.

Con esta misma interfaz se pueden rectificar y luego fusionar imágenes
oblicuas, o fusionar imágenes rectificadas. En la figura
\ref{fig:tutorial_fusion_rect} se muestra un ejemplo de configuración
para la rectificación y fusión de un grupo de imágenes oblicuas. Para
el ejemplo, se ingresa la siguiente información:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Image type}: snap
\item \emph{Select a fusion}: Default
\item Seleccionar la opción: \emph{Rectify and merge oblique images}
\item \emph{Initial time}: 01/05/2010 10:45:00
\item \emph{Final time}: 01/05/2010 22:45:00
\item \emph{Time error}: 3
\item \emph{Time step}: 30
\end{enumerate}

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_fusion_rect}
  \caption{Ejemplo de interfaz de fusión, imágenes rectificadas}
  \label{fig:tutorial_fusion_rect}
\end{figure}

En el ejemplo, se fusionan las imágenes rectificadas en el intervalo
de tiempo seleccionado. Al iniciar el proceso de fusión, aparece una
ventana de progreso donde es posible cancelar la ejecución (ver figura
\ref{fig:tutorial_fusion_rectprogress}).

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_fusion_rectprogress}
  \caption{Ventana de progreso del proceso de fusión}
  \label{fig:tutorial_fusion_rectprogress}
\end{figure}

Es posible escoger una fusión anterior desde el menú \textit{Select a
  fusion}, pero para este ejemplo, se dejará la opción por defecto, en
la que cada grupo de imágenes es fusionado con la fusión más cercana
(en tiempo) al tiempo de las imágenes, almacenada en la base de datos.

Para este tutorial, las imágenes serán guardadas solamente en el
disco. Se debe escoger la opción \textit{Save images in disk only} y
se debe seleccionar la ruta de destino haciendo clic en el botón
``$\ldots$''. Las imágenes quedan almacenadas como se muestra en la
figura~\ref{fig:tutorial_merged_rectfolder}.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_merged_rectfolder}
  \caption{Imágenes fusionadas almacenadas en disco}
  \label{fig:tutorial_merged_rectfolder}
\end{figure}

Para iniciar el proceso de fusión se debe presionar el botón
\textit{``Start fusion''}, y luego aparecerá una ventana de progreso
donde es posible cancelar la ejecución.

Si tiene alguna duda sobre cuál es el significado de alguna opción de
esta interfaz diríjase al manual de HORUS en la sección GUI en el
apartado de \emph{Manually merge images}.



\chapter{Configuración de Automáticos}

Los automáticos son programas que funcionan como servicios, en el
sentido que se ejecutan continuamente esperando un evento para
activarse y realizar una acción. En el sistema HORUS hay cuatro tipos
de automáticos: captura, transferencia, procesamiento y sincronización
entre bases de datos.

\section{Configuración del Automático de Captura y Transferencia}

Posterior a la configuración de las cámaras para la captura, se
procede a configurar el automático de captura. En la
figura~\ref{fig:tutorial_capture} se muestra un ejemplo de la
configuración de una captura. Para llamar a la interfaz, se debe
presionar el botón \textbf{Configure capture automatic} en la interfaz
principal.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_capture}
  \caption{Ejemplo de configuración de una captura}
  \label{fig:tutorial_capture}
\end{figure}

Al seleccionar una estación (e.g.\@ CARTAGENA), si ya hay una
configuración existente se cargan los parámetros en la interfaz.

\subsection{Configuración de la Captura de Imágenes}

El primer paso es configurar la captura de imágenes, estableciendo el
tiempo inicial y final durante el cual se llevará a cabo la captura,
el tamaño de paso o cada cuánto se activará el proceso de captura, el
tipo de imágenes que se capturará y el tiempo de captura (en
segundos). Este último valor es útil solamente para imágenes tipo
\textit{timex} y \textit{variance}. Para el ejemplo, los valores de
cada uno de estos campos es:

\begin{itemize}
\item \emph{Start time}: 06:30
\item \emph{End time}: 18:30
\item \emph{Time step}: 30
\item \emph{Capture time}: 120 (este campo se activa después de
  seleccionar un tipo de imagen \textit{timex} o \textit{variance} en
  el recuadro \textit{Image type})
\end{itemize}

En el ejemplo, se capturan imágenes tipo \textit{snap}, \textit{timex}
y \textit{variance}. Para cada estación, sólo es posible tener una
configuración de captura de imágenes.

\subsection{Configuración de la Captura de \textit{Stacks}}

Es posible tener varias configuraciones de \textit{stacks}, los cuales
son vídeos de una región determinada de la imagen. 

Seleccionar en la lista desplegable \textit{Capture} la opción
\textit{New capture}.

La información de la captura es casi igual que en el caso de la
captura de imágenes, excepto que el tipo de las imágenes es
instantánea, y el número de frames es un parámetro para la generación
del vídeo. Además, se debe escoger una región de interés (ROI). Para
el ejemplo, los valores de cada uno de estos campos para la captura de
\textit{stacks} son:

\begin{itemize}
\item \emph{Start time}: 10:15
\item \emph{End time}: 15:15
\item \emph{Time step}: 60
\item \emph{Number of frames}: 1200
\item \emph{Camera}: C1
\end{itemize}

Para seleccionar un ROI, se presiona el botón \emph{Select
  ROI...}. Para llevar a cabo este paso, es necesario haber
configurado previamente la cámara y almacenado esta configuración en
el archivo XML \texttt{capture\_info.xml}; esto es debido a que para
seleccionar un ROI, el sistema captura una imagen con la cámara y la
muestra, para que así, el usuario pueda seleccionar los puntos
correspondientes a los vértices del polígono que conforman el ROI. Para
seleccionar los puntos del ROI, se hace clic izquierdo sobre la imagen
y el último punto se marca con clic derecho para cerrar el polígono.

Para que la configuración del \textit{stack} pueda ser almacenada, se
debe presionar el botón \textit{Save stack in memory} que guarda la
configuración en memoria hasta que el usuario decida almacenar la
configuración en disco con el botón \textit{Save configuration}.

\subsection{Configuración de la Transferencia de Datos}

Por último, se debe configurar la transferencia de información desde
el servidor de captura hasta el servidor de procesamiento de las
imágenes. La transferencia se realiza por SSH, y adicionalmente, se
puede configurar un correo electrónico como remitente de mensajes de
error a un grupo de receptores. Al igual que en la captura, el envío
de datos se realiza en tiempos determinados. Las imágenes a ser
transferidas se guardan en una ruta local. Esto es una muestra de una
configuración ya que no se tendrá acceso por defecto a una conexión de
HORUS. El acceso al servidor mostrado en el ejemplo debe ser
coordinado con el equipo HORUS por el correo electrónico:
\href{mailto:horus.unal@gmail.com}{\texttt{horus.unal@gmail.com}}\\
Para el ejemplo, los datos de configuración de la transferencia son
(todas las contraseñas son encriptadas al guardarse en el XML):

\begin{itemize}
\item \emph{Data Host}: 168.176.124.168
\item \emph{Username}: HORUS
\item \emph{Password}: abc123
\item \emph{Start time}: 06:45
\item \emph{End time}: 18:45
\item \emph{Time step}: 30
\item \emph{Email account}: horus@horus.com
\item \emph{Email password}: abc123
\item \emph{Email recipients}: acc1@horus.com,acc2@horus.com
\item \emph{Remote path}: \verb!/home/horus/dbimage!
\end{itemize}

Por último, para almacenar estos datos se debe presionar el botón
\textit{Save configuration}.

La configuración de todos estos parámetros se guarda en el archivo
\texttt{capture\_info.xml}. El archivo de configuración para el
ejemplo es como sigue:

\begin{verbatim}
<?xml version="1.0" encoding="iso-8859-1"?>
<Configuration station="CARTAGENA">
    <CameraConfig>
        <Camera id="C1">
            <FrameRate>30/1</FrameRate>
            <GainMode>none</GainMode>
            <ShutterMode>none</ShutterMode>
            <WhiteBalanceMode>auto</WhiteBalanceMode>
            <AdaptorName>linuxvideo</AdaptorName>
            <DeviceID>1</DeviceID>
            <DeviceFormat>YUYV_640x360</DeviceFormat>
            <AOI>
                <mode>none</mode>
                <Height>none</Height>
                <Width>none</Width>
                <Left>none</Left>
                <Top>none</Top>
            </AOI>
        </Camera>
    </CameraConfig>
    <CaptureConfig>
        <Transfer FTPHost="168.176.124.168">
            <FTPUser>HORUS</FTPUser>
            <FTPPass>D1A91178B3437FC35D34B3A020B6F3F7</FTPPass>
            <StartHour>6</StartHour>
            <StartMinute>45</StartMinute>
            <EndHour>18</EndHour>
            <EndMinute>45</EndMinute>
            <TimeStep>30</TimeStep>
            <EmailUser>horus@horus.com</EmailUser>
            <EmailPass>D1A91178B3437FC35D34B3A020B6F3F7</EmailPass>
            <EmailRcpt>acc1@horus.com,acc2@horus.com</EmailRcpt>
            <RootPath>/home/horus/dbimage</RootPath>
        </Transfer>
        <Capture id="2" type="stack">
            <StartHour>10</StartHour>
            <StartMinute>15</StartMinute>
            <EndHour>15</EndHour>
            <EndMinute>15</EndMinute>
            <TimeStep>60</TimeStep>
            <NumberOfFrames>1200</NumberOfFrames>
            <ROI>
                <XCoords>10 30 70 50</XCoords>
                <YCoords>10 10 100 100</YCoords>
            </ROI>
        </Capture>
        <Capture id="3" type="image">
            <StartHour>6</StartHour>
            <StartMinute>30</StartMinute>
            <EndHour>18</EndHour>
            <EndMinute>30</EndMinute>
            <TimeStep>30</TimeStep>
            <CaptureTime>120</CaptureTime>
            <Snap>true</Snap>
            <Timex>true</Timex>
            <Var>true</Var>
        </Capture>
    </CaptureConfig>
    <CameraPerCaptureConfig>
        <CameraPerCapture camera="C1" capture="2"/>
        <CameraPerCapture camera="C1" capture="3"/>
    </CameraPerCaptureConfig>
</Configuration>
\end{verbatim}

Para utilizar los automáticos de captura y transferencia, es necesario
compilar las funciones \verb!auto_capture_images.m! y
\verb!auto_transfer.m! del directorio \texttt{src}, mediante los
botones \textit{Build capture automatic...} y \textit{Build transfer
  automatic...}, respectivamente, en la interfaz. Sin embargo, si se
quieren compilar manualmente, se ejecutan los siguientes comandos en
la línea de comandos de MATLAB (suponiendo que el directorio de HORUS
es \verb!C:\horus!):

\begin{flushleft}
  \verb!cd C:\horus!

  \verb!addpath('src')!

  \verb!mcc -m auto_capture_images -a ./data -I ./tmp!

  \verb!mcc -m auto_transfer -a ./data -I ./tmp!

\end{flushleft}

Si la compilación se realizó mediante la interfaz, se generan los
archivos ejecutables\\ \texttt{run\_auto\_capture\_images.bat} y
\texttt{run\_auto\_transfer.bat}.

Si los archivos se compilaron manualmente, en el sistema operativo
Windows, se generan dos ejecutables \texttt{auto\_capture\_images.exe}
y \texttt{auto\_transfer.exe}, los cuales reciben unos parámetros de
entrada. El automático de captura recibe el nombre de la estación, y
el automático de transferencia recibe el nombre de la estación y la
dirección IP del servidor al que se enviarán los datos. Para
ejecutarlos, se debe crear para cada uno, un archivo BAT que recibe
los parámetros. Un ejemplo de archivo BAT para el automático de
captura podría contener el siguiente código
(\texttt{run\_auto\_capture\_images.bat}):

\begin{flushleft}
  \verb!auto_capture_images.exe CARTAGENA!
\end{flushleft}

Para el automático de transferencia
(\texttt{run\_auto\_transfer.bat}):

\begin{flushleft}
  \verb!auto_transfer.exe CARTAGENA 168.176.124.165!
\end{flushleft}

Luego de ejecutar estos archivos BAT, comenzará el proceso de captura
y transferencia de información.

\emph{Nota:} Es posible que al compilar el automático de transferencia
aparezca un mensaje de advertencia. Esto es normal y se puede hacer
caso omiso de él.

\section{Configuración del Automático de Procesamiento}

El automático de procesamiento es el encargado de realizar la
rectificación, fusión y generación de miniaturas en el servidor de
procesamiento. Al igual que el automático de captura, es un programa
que se ejecuta continuamente y cada cierto tiempo realiza las tareas
especificadas. Para ejecutar la interfaz se debe presionar el botón
\textbf{Configure processing automatic} en la interfaz principal.

En la figura~\ref{fig:tutorial_processing} se muestra un ejemplo de
configuración de procesamiento.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.6\textwidth]{img/tutorial_processing}
  \caption{Interfaz de configuración del automático de procesamiento}
  \label{fig:tutorial_processing}
\end{figure}

Al seleccionar una estación (e.g.\@ CARTAGENA), si ya hay una
configuración existente se cargan los parámetros en la interfaz.

El primer paso es la configuración del procesamiento de imágenes. Para
el ejemplo, los valores de cada uno de estos campos son:

\begin{itemize}
\item \emph{Start time}: 06:50
\item \emph{End time}: 18:50
\item \emph{Time step}: 30
\end{itemize}

Los tipos de imágenes que se deben generar en este caso son imágenes
oblicuas--fusionadas (\textit{Merge oblique images}) y
rectificadas--fusionadas (\textit{Rectify and merge oblique images}),
para imágenes \textit{snap}.

Opcionalmente, es posible definir la información de transferencia de
las miniaturas a la web. Esto es una muestra de configuración ya que
no se tendrá acceso por defecto a una conexión con el servidor de
HORUS, el acceso al servidor debe ser coordinado con el equipo HORUS
por el correo electrónico:
\href{mailto:horus.unal@gmail.com}{\texttt{horus.unal@gmail.com}}\\
Para el ejemplo, los valores de los campos diligenciados son los
siguientes:

\begin{itemize}
\item \emph{Upload thumbs to the web}: $\checkmark$
\item \emph{Data Host}: www.horusvideo.com
\item \emph{Username}: horus
\item \emph{Password}: abc123
\end{itemize}

Para la generación de miniaturas, se define el tipo de imágenes
procesadas que se quieren miniaturizar, en este caso, oblicuas
(\textit{Oblique}), oblicuas--fusionadas (\textit{Merge--oblique}) y
rectificadas--fusionadas (\textit{Merged--rectified}) para imágenes
\textit{snap}, y el ancho deseado de la miniatura (el alto de la
imagen se calcula proporcional al ancho seleccionado), en este
caso es 120.

Para guardar los cambios presione el botón \textit{Save
  configuration}.

La información del procesamiento se almacena en el archivo
\texttt{processing\_info.xml}. Para el ejemplo, este archivo contiene
la siguiente información:

\begin{verbatim}
<?xml version="1.0" encoding="iso-8859-1"?>
<Configuration station="CARTAGENA">
    <ImageProcessingConfig>
        <StartHour>6</StartHour>
        <StartMinute>15</StartMinute>
        <EndHour>18</EndHour>
        <EndMinute>15</EndMinute>
        <TimeStep>30</TimeStep>
        <MergeOnly>true</MergeOnly>
        <RectifyOnly>false</RectifyOnly>
        <RectifyAndMerge>false</RectifyAndMerge>
        <Snap>true</Snap>
        <Timex>false</Timex>
        <Variance>false</Variance>
    </ImageProcessingConfig>
    <ThumbnailsConfig>
        <Rectified>false</Rectified>
        <Oblique>false</Oblique>
        <MergedRectified>true</MergedRectified>
        <MergedOblique>true</MergedOblique>
        <ThumbWidth>120</ThumbWidth>
        <UploadFTPHost>www.horusvideo.com</UploadFTPHost>
        <UploadFTPUser>horus</UploadFTPUser>
        <UploadFTPPass>abc123</UploadFTPPass>
        <Snap>true</Snap>
        <Timex>false</Timex>
        <Variance>false</Variance>
    </ThumbnailsConfig>
</Configuration>
\end{verbatim}

Para utilizar el automático de procesamiento, es necesario compilar la
función\\ \verb!auto_process_images.m! del directorio \texttt{src},
mediante el botón \textit{Build processing automatic...} en la
interfaz. Sin embargo, si se quiere compilar manualmente, se ejecutan
los siguientes comandos en la línea de comandos de MATLAB (suponiendo
que el directorio de HORUS es \verb!C:\horus!):

\begin{flushleft}
  \verb!cd C:\horus!

  \verb!addpath('src')!

  \verb!mcc -m auto_process_images -a ./data -I ./tmp!

\end{flushleft}

Si la compilación se realizó mediante la interfaz, se genera el
archivo ejecutable\\ \texttt{run\_auto\_process\_images.bat}. Al
presionar el botón que lleva a cabo la compilación, se le pide al
usuario ingresar el tamaño de paso y el error (en minutos) para la
búsqueda de las imágenes que se desean procesar.

Si el archivo se compiló manualmente, en el sistema operativo Windows,
se genera un ejecutable\\ \texttt{auto\_process\_images.exe}, el cual
recibe unos parámetros de entrada: nombre de la estación, tamaño de
paso para la búsqueda de imágenes (en minutos) y error en la búsqueda
(en minutos). Para ejecutarlo, se debe crear un archivo BAT que recibe
los parámetros. Un ejemplo de archivo BAT para el automático de
procesamiento podría contener el siguiente código\\
(\texttt{run\_auto\_process\_images.bat}):

\begin{flushleft}
  \verb!auto_process_images.exe CARTAGENA 30 5!
\end{flushleft}

Luego de ejecutar el archivo BAT, comenzará el procesamiento de las
imágenes.


\chapter{Configuración y subida de miniaturas a la web}

En esta sección se explicará cómo generar miniaturas que por lo
general son usadas para ser subidas a una página web. Para ejecutar la
interfaz de configuración de miniaturas se debe presionar el botón
\textbf{Configure thumbnail generation} en la interfaz principal.

Para continuar, se debe ingresar la información solicitada:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Thumbnail type}: oblique
\item \emph{Initial time}: 01/05/2010 10:45:00
\item \emph{Final time}: 03/05/2010 20:45:00
\item \emph{Image type}: Se selecciona \textit{timex} y \textit{snap}
\item \emph{Desired width}: 120
\end{enumerate}

Se supone que se desea insertar la información de las miniaturas en la
base de datos y subir las imágenes al \textit{hosting}. En la parte
derecha de la interfaz, se seleccionarán las opciones \emph{Upload
  hosting} que se usa para crear un archivo con la información de las
imágenes (más adelante se describirá cómo subirlas, y \emph{Insert to
  database} lo que hace que aparezca en \emph{Destination path} la
ruta donde se van a guardar las imágenes. En la
figura~\ref{fig:tutorial_thumbnail} se muestra la interfaz
diligenciada. Para iniciar el proceso se presiona el botón
\emph{Start}. Luego de esto, se mostrará una barra de progreso con la
cual se puede cancelar la operación en cualquier momento.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_thumbnail}
  \caption{Interfaz diligenciada para la generación de miniaturas}
  \label{fig:tutorial_thumbnail}
\end{figure}

En la figura~\ref{fig:tutorial_thumbnail2} se muestra uno de los
resultados de la miniaturización de las imágenes junto con la imagen
original para la cámara C1.

\begin{figure}[htbp!]
  \centering
  \includegraphics[scale=0.5]{img/tutorial_original}
  \includegraphics[scale=0.5]{img/tutorial_thumbnail2}
  \caption{Imagen miniatura cámara C1}
  \label{fig:tutorial_thumbnail2}
\end{figure}

En este punto, no se han subido las miniaturas al \textit{hosting},
sólo se ha creado un archivo temporal con la lista de imágenes a
subir.

A continuación se explicará cómo subir imágenes miniaturas al
\texttt{hosting}. Para ejecutar la interfaz para la configuración de
los parámetros de subida se debe presionar el botón \textbf{Configure
  thumbnail upload} en la interfaz principal.

En la figura~\ref{fig:tutorial_upload_hosting} se muestra la interfaz
diligenciada con datos de ejemplo (estos datos no son reales, para
establecer una conexión real los datos deben ser solicitados al equipo
HORUS al correo electrónico:
\href{mailto:horus.unal@gmail.com}{horus.unal@gmail.com}). Después de
ingresar la información se debe presionar el botón \textit{Save
  configuration} el cual guardará la información ingresada en el
archivo XML \texttt{processing\_info.xml}. Después de esto, se
presiona el botón \textit{Upload to hosting} que iniciará el proceso
de subida. Durante el proceso se mostrará una barra de progreso con la
cual se puede cancelar la operación en cualquier momento.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tutorial_upload_hosting}
  \caption{Interfaz para subir las miniaturas con la información
    diligenciada}
  \label{fig:tutorial_upload_hosting}
\end{figure}

Si tiene alguna duda sobre el tipo de dato o cuál es el significado de
alguna opción de esta interfaz diríjase al manual de HORUS en la
sección GUI en el apartado de \emph{Configure thumbnail generation and
  upload}.



\chapter{Insertar sensor y mediciones}

\section{Sensor}

En esta parte del tutorial se explicará cómo se deben ingresar los
sensores y los datos de éstos a la base de datos. Esta configuración
se realiza desde la interfaz \textbf{Edit database}, presionando el
botón correspondiente en la interfaz principal. Los pasos son los
siguientes:

\begin{itemize}
\item Ir al menú superior \emph{Edit Sensor}.
\item Seleccionar de la lista desplegable \emph{Station} la estación a
  la cual se asociará el sensor, para el ejemplo se debe seleccionar
  CARTAGENA.
\item En la lista desplegable \emph{Sensor} se selecciona \emph{New
    sensor}.
\item Ingresar la información solicitada con los datos del
  sensor. Como ejemplo se ingresará:
\end{itemize}

\begin{enumerate}
\item \emph{Name}: sensor\_marea
\item \emph{X}: 658.45269
\item \emph{Y}: 756.1568
\item \emph{Z}: 0
\item \emph{Description}: Este sensor reporta datos de marea
  correspondientes a la bahía de Cartagena.
\end{enumerate}

En la figura~\ref{fig:tutorial_sensor} se muestra la interfaz
diligenciada.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.6\textwidth]{img/tutorial_sensor}
  \caption{Interfaz diligenciada con el sensor}
  \label{fig:tutorial_sensor}
\end{figure}

\begin{itemize}
\item Por último se presiona el botón \emph{Insert}.
\item Se mostrará una ventana de confirmación en la cual se responde
  \emph{Yes}.
\item Al finalizar la inserción se mostrará una ventana indicando el
  éxito o el fracaso de la operación.
\end{itemize}

Esta interfaz también cuenta con la opción de actualizar un sensor
seleccionándolo de la lista desplegable \emph{Sensor}, cambiando la
información necesaria y presionando el botón \emph{Update}.

Si tiene alguna duda sobre el tipo de dato o cuál es el significado de
alguna opción de esta interfaz diríjase al manual de HORUS en la
sección GUI en el apartado de \emph{Edit database} - Sensor.

\section{Mediciones}

El tipo de medición es lo que mide el sensor, por ejemplo, marea,
altura de ola, dirección de oleaje entre otros. Esta configuración se
realiza desde la interfaz \textbf{Edit database} (para ejecutar la
interfaz se presiona el botón correspondiente en la interfaz
principal). Los pasos son los siguientes:

\begin{itemize}
\item Ir a \emph{Edit Measurement Type}.
\item Seleccionar de la lista desplegable \emph{Station} la estación a
  la cual corresponden los datos, para el ejemplo se selecciona
  CARTAGENA.
\item En la lista desplegable \emph{Measurement} se selecciona
  \emph{New measurement type}.
\item Ingresar la información solicitada con los datos del tipo de
  medición. Como ejemplo se ingresará:
  \begin{enumerate}
  \item \emph{Sensor}: sensor\_marea
  \item \emph{Name}: Marea
  \item \emph{Data Type}: time series
  \item \emph{Unit Y}: m
  \item \emph{Description}: Marea astronómica (metros) calculada con
    análisis de armónicos calibrado con la serie histórica del
    mareógrafo de la bahía de Cartagena.
  \end{enumerate}
\end{itemize}

Se dejan los demás campos sin llenar para este ejemplo. En este paso
se pueden realizar dos acciones, una es presionar el botón
\emph{Insert} para ingresar esta información a la base de datos, o la
otra opción es presionar el botón \emph{Import Data} y en la ventana
que se muestra, seleccionar un archivo de Excel o un archivo con el
formato MAT (de MATLAB) que contenga los datos del sensor. Para el
ejemplo, se utilizará la opción \textit{Import Data} y se seleccionará
el archivo \emph{marea.mat} que se encuentra en el directorio
\emph{examples} (tener en cuenta que se debe habilitar la opción de
visualizar archivos MAT o todos los archivos, ya que por defecto se
visualizan archivos XLS).  La estructura de este archivo depende del
tipo de datos, si es una serie de tiempo el archivo en Excel debe
contener dos columnas: la primera, con la fecha en formato
\texttt{datenum} de Matlab, y la segunda con el valor. Si es un
archivo MAT, se debe de tener en cuenta que éste sólo puede tener una
matriz que tendrá igualmente dos columnas, en la primera la fecha en
formato \texttt{datenum} y en la segunda, el valor para esa fecha. Si
el tipo de datos es matriz, el archivo en Excel o el MAT debe contener
en la primera columna los valores de $X$, en la segunda columna los
valores de $Y$, y en la tercera los valores de $Z$. En la
figura~\ref{fig:tutorial_measurement} se muestra la interfaz
diligenciada.  Después de haber seleccionado el archivo, se presiona
el botón \emph{Insert} para almacenar toda la información en la base
de datos. Esta inserción puede tardar unos segundos dependiendo de la
cantidad de datos a insertar.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=0.6\textwidth]{img/tutorial_measurement}
  \caption{Interfaz diligenciada con el tipo de medición}
  \label{fig:tutorial_measurement}
\end{figure}

Esta interfaz también cuenta con la opción de actualizar un tipo de
medición seleccionándolo de la lista desplegable \emph{Measurement},
cambiando la información necesaria y presionando el botón
\emph{Update}. Si se desean agregar más datos del sensor sólo se
selecciona el tipo de medición en la lista desplegable
\emph{Measurement} y luego se presiona el botón \emph{Import Data},
se selecciona el archivo que debe tener los datos con la estructura ya
mencionada y por último se presiona el botón \emph{Update}.

Si tiene alguna duda sobre el tipo de dato o cuál es el significado de
alguna opción de esta interfaz diríjase al manual de HORUS en la
sección GUI en el apartado de \emph{Edit database} - Tipo de medición.


\appendix
\chapter{Creación de un ROI desde cero}
\label{app:roi}

En esta sección se explicará la segunda manera de utilizar la interfaz
para crear un ROI para la calibración, es decir, presionando el botón
\textbf{Create new ROI} en la interfaz principal. Como ejemplo se
ingresa la siguiente información en la interfaz:

\begin{enumerate}
\item \emph{Station}: CARTAGENA
\item \emph{Camera}: C1
\item \emph{Timestamp Calibration}: 01-May-2010 10:45:00
\item \emph{Type}: rect
\item \emph{Timestamp ROI}: New ROI
\item \emph{New Timestamp ROI}: 01/05/2010 10:45:00
\end{enumerate}

Luego de llenar esta información se presiona el botón \emph{Load
  Images} que carga el nombre de las imágenes en la lista desplegable
\emph{Select Image}, en la cual se seleccionará la imagen que se desee
mostrar en la parte izquierda de la interfaz.

Luego, se selecciona la región de interés en la imagen por medio del
botón \emph{Mark Points} el cual habilita la marcación. Se debe tener
en cuenta que el último punto del polígono debe ser marcado con clic
derecho para cerrarlo. Si es necesario, en la parte superior izquierda
se encuentran las opciones de \textit{zoom}, desplazamiento en la
imagen y borrado de un punto marcado. Al marcar los puntos, se
muestran las coordenadas $(u, v)$ en la parte derecha de la interfaz
en \emph{U Points} y en \emph{V Points}:

\begin{verbatim}
U Points: 60.17  457.98  979.56 1020.82 1020.82  391.68
V Points: 293.89 762.42 765.37 727.06 248.21  74.35
\end{verbatim}


Estas coordenadas pueden ser escritas directamente en los campos de
texto \emph{U Points} y \emph{V Points} y al presionar \textit{Enter}
después de haber escrito todas las coordenadas, éstas se graficarán
sobre la imagen. En la figura~\ref{fig:tutorial_roi2} se muestra la
interfaz después de diligenciada.  Por último, si se está satisfecho
con el ROI se procede a guardarlo presionando el botón \emph{Insert
  ROI}, esto mostrará una ventana para confirmar la inserción en la
cual se responderá \emph{Yes}. Al finalizar el proceso se mostrará una
ventana indicando el éxito o el fracaso de la operación.

\begin{figure}[htbp!]
  \centering
  \includegraphics[width=\textwidth]{img/tutorial_roi2}
  \caption{Interfaz de creación de un ROI}
  \label{fig:tutorial_roi2}
\end{figure}

Esta interfaz también tiene la opción de actualizar las coordenadas
de un ROI, para esto se debe seleccionar en \emph{Timestamp ROI} una
fecha y se realiza la nueva marcación. Por último se presiona el
botón \emph{Update ROI}.

Si tiene alguna duda sobre cuál es el significado de alguna opción
de esta interfaz diríjase al manual de HORUS en la sección GUI en el
apartado de \emph{Create new ROI}.


\end{document}
